<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Protocol Diagnostic</title>
    <style>
        /* All previous styles remain the same... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2d3748;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .logo {
            font-size: 14px;
            font-weight: 600;
            color: #4299e1;
            letter-spacing: 2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .header h1 {
            font-size: 36px;
            color: #1a365d;
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .header h2 {
            font-size: 20px;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .welcome-message {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4299e1;
        }
        
        .welcome-message h3 {
            color: #1a365d;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        .welcome-message p {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .welcome-message .user-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(66, 153, 225, 0.3);
            font-size: 15px;
        }
        
        .welcome-message .user-info strong {
            color: #2d3748;
        }
        
        .welcome-message .confidential-note {
            font-size: 14px;
            color: #718096;
            font-style: italic;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(66, 153, 225, 0.2);
        }
        
        .subtitle {
            font-style: italic;
            color: #718096;
            max-width: 700px;
            margin: 0 auto;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .diagnostic-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .question-card {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8fafc;
            border-radius: 16px;
            border-left: 5px solid #4299e1;
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .question-number {
            display: inline-block;
            background: #4299e1;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            text-align: center;
            line-height: 36px;
            font-weight: bold;
            margin-right: 15px;
            margin-bottom: 20px;
        }
        
        .question-title {
            display: inline;
            font-size: 22px;
            color: #2d3748;
            font-weight: 700;
        }
        
        .question-text {
            font-size: 18px;
            color: #4a5568;
            margin: 20px 0;
            line-height: 1.6;
            padding-left: 5px;
        }
        
        .risk-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .risk-box {
            padding: 25px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .risk-box:hover {
            transform: translateY(-3px);
        }
        
        .risk-box.selected {
            border-color: rgba(0, 0, 0, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .risk-box::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .risk-box.selected::after {
            opacity: 1;
        }
        
        .risk-high {
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
        }
        
        .risk-moderate {
            background: linear-gradient(135deg, #feebc8 0%, #f6ad55 100%);
            color: #744210;
        }
        
        .risk-optimal {
            background: linear-gradient(135deg, #c6f6d5 0%, #68d391 100%);
            color: #22543d;
        }
        
        .risk-label {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-high .risk-label {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .risk-moderate .risk-label {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .risk-optimal .risk-label {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .score-range {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .risk-description {
            font-size: 15px;
            line-height: 1.5;
            opacity: 0.95;
        }
        
        .results-panel {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            text-align: center;
            position: sticky;
            top: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .results-panel h3 {
            color: #2d3748;
            font-size: 24px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .urgency-meter {
            margin: 30px 0;
        }
        
        .urgency-score {
            font-size: 72px;
            font-weight: 800;
            margin: 20px 0;
            line-height: 1;
        }
        
        .high-urgency { color: #e53e3e; }
        .medium-urgency { color: #d69e2e; }
        .low-urgency { color: #38a169; }
        
        .urgency-label {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .progress-container {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #38a169 0%, #d69e2e 50%, #e53e3e 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .urgency-description {
            font-size: 16px;
            color: #4a5568;
            line-height: 1.6;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .cta-button {
            background: linear-gradient(135deg, #2b6cb0 0%, #4299e1 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }
        
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.4);
        }
        
        .cta-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .questions-complete {
            color: #38a169;
            font-weight: 600;
            margin-top: 15px;
            font-size: 16px;
        }
        
        @media (min-width: 1024px) {
            .container {
                display: grid;
                grid-template-columns: 1fr 350px;
                gap: 30px;
            }
            
            .header, .diagnostic-container {
                grid-column: 1;
            }
            
            .results-panel {
                grid-column: 2;
                grid-row: 1 / span 2;
                height: fit-content;
            }
        }
        
        @media (max-width: 1023px) {
            .results-panel {
                margin-top: 40px;
            }
        }
        
        .score-explanation {
            font-size: 14px;
            color: #718096;
            margin-top: 10px;
        }
        
        .user-info-summary {
            text-align: left;
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .clear-data-button {
            background: none;
            border: 1px solid #cbd5e0;
            color: #718096;
            padding: 10px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .clear-data-button:hover {
            background: #f8fafc;
            border-color: #4299e1;
            color: #2d3748;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4299e1;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-message {
            font-size: 18px;
            color: #2d3748;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">SOVEREIGN PROTOCOL</div>
            <h1>Executive Performance Diagnostic</h1>
            <h2>Stop Losing $1,600 a Day to Decision Fatigue<br>Reveal Your Hidden Performance Gap</h2>
            
            <!-- Welcome Message Area -->
            <div id="welcomeMessage"></div>
            
            <p class="subtitle">"The multi-billion dollar gap between strategy and results is a human performance gap, rooted in the leader's cognitive and emotional load."</p>
        </div>
        
        <div class="diagnostic-container" id="diagnosticContainer">
            <!-- All question cards remain the same... -->
            <!-- Question 1 -->
            <div class="question-card" data-question="1">
                <div class="question-number">1</div>
                <div class="question-title">MENTAL SOVEREIGNTY</div>
                <p class="question-text">How often do you experience analysis paralysis on key strategic decisions?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">Daily, with significant delay and clutter.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">Weekly, with moderate friction.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">Rarely; strategic clarity comes quickly.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 2 -->
            <div class="question-card" data-question="2">
                <div class="question-number">2</div>
                <div class="question-title">STRATEGIC TIME RECOVERY</div>
                <p class="question-text">How many hours of high-value thinking do you lose daily to reactive work?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">4+ hours lost. I'm constantly in the weeds.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">2-3 hours lost. It's a constant battle.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">0-1 hours lost. I fiercely protect strategic time.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 3 -->
            <div class="question-card" data-question="3">
                <div class="question-number">3</div>
                <div class="question-title">INFLUENTIAL PRESENCE</div>
                <p class="question-text">When pressure is high, does your team look to you for calm or for cues to panic?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">My team often mirrors my stress, leading to uncertainty and reactivity.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">Inconsistent. I have composed days, but pressure sometimes leaks through.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">Consistently. I am the calm in the storm, and my clarity directs the team.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 4 -->
            <div class="question-card" data-question="4">
                <div class="question-number">4</div>
                <div class="question-title">PURPOSE ALIGNMENT</div>
                <p class="question-text">Does your daily grind fuel your legacy, or distract from it?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">Less than 20% alignment. Most days are spent on obligations, not mission-critical work.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">About 50/50. I contribute to the mission, but get side-tracked by organizational "noise."</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">Over 80%. I end most days knowing my work meaningfully advanced core goals.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 5 -->
            <div class="question-card" data-question="5">
                <div class="question-number">5</div>
                <div class="question-title">EMOTIONAL COMPOSURE</div>
                <p class="question-text">When triggered, do you lead from strategy or from emotion?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">Often reactive. My emotional response creates friction, and recovery takes time.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">A mix. I can be strategic, but high-stakes triggers can still provoke a reactive response.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">Consistently strategic. I create a pause between stimulus and response.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 6 -->
            <div class="question-card" data-question="6">
                <div class="question-number">6</div>
                <div class="question-title">DECISION VELOCITY</div>
                <p class="question-text">Are you driving market change, or reacting to it?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">6-8 months behind. I am often playing catch-up to competitors and shifts.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">Moving at market pace. I see opportunities as they emerge, not before.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">6-8 months ahead. I identify and capture key opportunities well before they become obvious.</p>
                    </div>
                </div>
            </div>
            
            <!-- Question 7 -->
            <div class="question-card" data-question="7">
                <div class="question-number">7</div>
                <div class="question-title">ENERGY SUSTAINABILITY</div>
                <p class="question-text">Is your energy a renewable asset or a draining liability?</p>
                
                <div class="risk-boxes">
                    <div class="risk-box risk-high" data-score="3">
                        <div class="risk-label">High Risk</div>
                        <div class="score-range">1-3 Points</div>
                        <p class="risk-description">Daily crashes or burnout cycles. My energy is inconsistent and unreliable.</p>
                    </div>
                    
                    <div class="risk-box risk-moderate" data-score="2">
                        <div class="risk-label">Moderate Risk</div>
                        <div class="score-range">4-7 Points</div>
                        <p class="risk-description">2-3 times per week. I hit significant energy walls that derail my focus.</p>
                    </div>
                    
                    <div class="risk-box risk-optimal" data-score="1">
                        <div class="risk-label">Optimal</div>
                        <div class="score-range">8-10 Points</div>
                        <p class="risk-description">Rarely. My energy is sustained, renewable, and matched to my peak cognitive demands.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-panel">
            <h3>Your Performance Score</h3>
            
            <!-- User Info Summary -->
            <div id="userInfoSummary" class="user-info-summary">
                <p><strong>Diagnostic for:</strong> <span id="userNameDisplay">Loading...</span></p>
                <p><strong>Email for results:</strong> <span id="userEmailDisplay">Loading...</span></p>
                <p><strong>Role:</strong> <span id="userRoleDisplay">Loading...</span></p>
            </div>
            
            <div class="urgency-meter">
                <div class="urgency-label" id="urgencyLabel">Complete Diagnostic</div>
                <div class="urgency-score" id="performanceScore">0%</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="score-explanation">Max Score: 70% (Elite Performance)</div>
            </div>
            
            <div class="urgency-description" id="urgencyDescription">
                Answer all questions to see your performance score and personalized recommendations.
            </div>
            
            <button class="cta-button" id="ctaButton" disabled>
                Submit Diagnostic & Get Your Protocol
            </button>
            
            <div class="questions-complete" id="completionStatus">
                0/7 questions answered
            </div>
            
            <!-- Clear Data Button -->
            <button class="clear-data-button" id="clearDataButton">
                Clear My Data & Start Over
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-message">Generating your PDF and sending to your email...</div>
    </div>

    <script>
        // ====================
        // USER DATA RETRIEVAL AND STORAGE
        // ====================
        let userData = JSON.parse(localStorage.getItem('sovereignUserData') || '{}');
        console.log('User data retrieved:', userData);
        
        // Function to store user data
        function storeUserData(data) {
            userData = {...userData, ...data};
            localStorage.setItem('sovereignUserData', JSON.stringify(userData));
            updateUserDisplay();
        }
        
        // Function to update user display
        function updateUserDisplay() {
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userRoleDisplay = document.getElementById('userRoleDisplay');
            
            userNameDisplay.textContent = userData.name || 'Not provided';
            userEmailDisplay.textContent = userData.email || 'Not provided';
            userRoleDisplay.textContent = userData.role || 'Not provided';
        }
        
        // ====================
        // PDF GENERATION AND EMAIL FUNCTION
        // ====================
        async function generatePDFAndSendEmail(diagnosticResults) {
            showLoading(true);
            
            try {
                // Generate PDF content
                const pdfContent = generatePDFContent(diagnosticResults);
                
                // Send email with PDF attachment
                const emailSent = await sendEmailWithPDF(diagnosticResults, pdfContent);
                
                if (emailSent) {
                    console.log('Email sent successfully');
                } else {
                    alert('PDF generated but email could not be sent. Please contact support.');
                }
            } catch (error) {
                console.error('Error generating PDF/sending email:', error);
                alert('Error processing your request. Please try again or contact support.');
            } finally {
                showLoading(false);
                // Redirect based on percentage score
                redirectBasedOnScore(diagnosticResults.percentageScore);
            }
        }
        
        function generatePDFContent(results) {
            const { user, scores, totalScore, percentageScore, urgencyLevel } = results;
            
            // Create comprehensive PDF content
            const content = `
                SOVEREIGN PROTOCOL - EXECUTIVE DIAGNOSTIC REPORT
                ==================================================
                
                Prepared for: ${user.name || 'Anonymous'}
                Email: ${user.email || 'Not provided'}
                Role: ${user.role || 'Not provided'}
                Date: ${new Date().toLocaleDateString()}
                
                EXECUTIVE SUMMARY
                -----------------
                Performance Score: ${percentageScore}% / 70%
                Urgency Level: ${urgencyLevel}
                
                Based on your responses, your leadership architecture requires:
                ${getUrgencyRecommendation(urgencyLevel)}
                
                DETAILED ANALYSIS
                -----------------
                
                MENTAL SOVEREIGNTY: ${getScoreDescription(scores[1])}
                - Your response indicates: ${getQuestionDescription(1, scores[1])}
                
                STRATEGIC TIME RECOVERY: ${getScoreDescription(scores[2])}
                - Your response indicates: ${getQuestionDescription(2, scores[2])}
                
                INFLUENTIAL PRESENCE: ${getScoreDescription(scores[3])}
                - Your response indicates: ${getQuestionDescription(3, scores[3])}
                
                PURPOSE ALIGNMENT: ${getScoreDescription(scores[4])}
                - Your response indicates: ${getQuestionDescription(4, scores[4])}
                
                EMOTIONAL COMPOSURE: ${getScoreDescription(scores[5])}
                - Your response indicates: ${getQuestionDescription(5, scores[5])}
                
                DECISION VELOCITY: ${getScoreDescription(scores[6])}
                - Your response indicates: ${getQuestionDescription(6, scores[6])}
                
                ENERGY SUSTAINABILITY: ${getScoreDescription(scores[7])}
                - Your response indicates: ${getQuestionDescription(7, scores[7])}
                
                RECOMMENDED ACTIONS
                -------------------
                ${getRecommendedActions(urgencyLevel)}
                
                NEXT STEPS
                ----------
                1. Review this report carefully
                2. Schedule implementation within the recommended timeframe
                3. Implement the corrective actions systematically
                
                CONFIDENTIALITY NOTICE
                ----------------------
                This report is confidential and intended solely for the recipient.
                
                © 2026 Sovereign Protocol. All rights reserved.
            `;
            
            return content;
        }
        
        function getScoreDescription(score) {
            if (score === 3) return 'High Risk (Needs Immediate Attention)';
            if (score === 2) return 'Moderate Risk (Improvement Recommended)';
            if (score === 1) return 'Optimal (Well Positioned)';
            return 'Not Assessed';
        }
        
        function getQuestionDescription(questionNum, score) {
            const descriptions = {
                1: {
                    1: 'Strong mental sovereignty with quick strategic clarity',
                    2: 'Moderate analysis paralysis requiring weekly attention',
                    3: 'Significant analysis paralysis causing daily delays'
                },
                2: {
                    1: 'Excellent protection of strategic thinking time',
                    2: 'Moderate loss of strategic time (2-3 hours daily)',
                    3: 'Significant loss of strategic capacity (4+ hours daily)'
                },
                3: {
                    1: 'Consistent calming presence under pressure',
                    2: 'Inconsistent emotional regulation',
                    3: 'Team mirrors stress and uncertainty'
                },
                4: {
                    1: 'High purpose alignment (>80% daily)',
                    2: 'Moderate alignment (about 50%)',
                    3: 'Low alignment (<20%) with significant distraction'
                },
                5: {
                    1: 'Strategic response to triggers',
                    2: 'Mixed strategic/emotional responses',
                    3: 'Reactive emotional responses creating friction'
                },
                6: {
                    1: 'Proactive market leadership (6-8 months ahead)',
                    2: 'Market pace maintenance',
                    3: 'Reactive position (6-8 months behind)'
                },
                7: {
                    1: 'Sustainable, renewable energy',
                    2: 'Periodic energy walls (2-3 times weekly)',
                    3: 'Inconsistent energy with daily crashes'
                }
            };
            
            return descriptions[questionNum]?.[score] || 'Not assessed';
        }
        
        function getUrgencyRecommendation(level) {
            const recommendations = {
                'CRITICAL': 'Immediate intervention required. Your leadership performance is significantly compromised.',
                'HIGH': 'Prompt intervention recommended. Key performance gaps need to be addressed.',
                'MODERATE': 'Performance optimization opportunity. Systematic protocols will elevate your leadership.'
            };
            return recommendations[level] || 'Regular performance monitoring recommended.';
        }
        
        function getRecommendedActions(level) {
            const actions = {
                'CRITICAL': `
                    1. IMMEDIATE: Schedule executive calibration session
                    2. WITHIN 3 DAYS: Implement decision-making protocols
                    3. WITHIN 7 DAYS: Restructure strategic time allocation
                    4. COMPLETE: Fragmented Brief Drill
                `,
                'HIGH': `
                    1. WITHIN 7 DAYS: Conduct leadership architecture review
                    2. WITHIN 14 DAYS: Implement strategic time recovery system
                    3. MONTHLY: Performance calibration sessions
                    4. COMPLETE: Transition Brief Drill
                `,
                'MODERATE': `
                    1. WITHIN 30 DAYS: Implement systematic performance protocols
                    2. QUARTERLY: Strategic alignment reviews
                    3. CONTINUOUS: Performance optimization practices
                    4. COMPLETE: Integrated Brief Drill
                `
            };
            return actions[level] || 'Regular performance monitoring and adjustment.';
        }
        
        async function sendEmailWithPDF(results, pdfContent) {
            // Replace with your actual email service integration
            // Options: EmailJS, SendGrid, Mailgun, Formspree, etc.
            
            const serviceID = 'YOUR_SERVICE_ID'; // From EmailJS
            const templateID = 'YOUR_TEMPLATE_ID'; // From EmailJS
            const publicKey = 'YOUR_PUBLIC_KEY'; // From EmailJS
            
            const emailData = {
                service_id: serviceID,
                template_id: templateID,
                user_id: publicKey,
                template_params: {
                    'to_email': userData.email,
                    'from_name': 'Sovereign Protocol',
                    'to_name': userData.name || 'Executive',
                    'message': `Your Sovereign Protocol diagnostic results are attached.\n\nPerformance Score: ${results.percentageScore}%\nUrgency Level: ${results.urgencyLevel}`,
                    'pdf_content': pdfContent,
                    'user_email': userData.email,
                    'user_name': userData.name || 'Executive',
                    'total_score': results.percentageScore,
                    'urgency_level': results.urgencyLevel
                }
            };
            
            try {
                // Using EmailJS for email with attachments
                // You need to sign up at https://www.emailjs.com/
                // Alternative: Use your own backend with SendGrid/Mailgun
                
                /*
                const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emailData)
                });
                
                return response.ok;
                */
                
                // For demonstration - simulate success
                console.log('Simulating email send to:', userData.email);
                console.log('PDF content generated successfully');
                return true;
                
            } catch (error) {
                console.error('Email sending error:', error);
                return false;
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
        
        // ====================
        // REDIRECT BASED ON PERCENTAGE SCORE (0-70)
        // ====================
        function redirectBasedOnScore(percentageScore) {
            console.log(`Percentage score: ${percentageScore}%`);
            
            let redirectUrl = '';
            if (percentageScore <= 30) {
                redirectUrl = '/fragmentedbriefdrill.html';
            } else if (percentageScore <= 50) {
                redirectUrl = '/transitionbriefdrill.html';
            } else {
                redirectUrl = '/integratedbriefdrill.html';
            }
            
            console.log(`Redirecting to: ${redirectUrl}`);
            window.location.href = redirectUrl;
        }
        
        // ====================
        // DIAGNOSTIC LOGIC
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            const clearDataButton = document.getElementById('clearDataButton');
            
            // Display personalized welcome message
            if (userData.name || userData.email) {
                let welcomeHTML = '<div class="welcome-message">';
                
                if (userData.name) {
                    welcomeHTML += `<h3>Welcome, ${userData.name}</h3>`;
                } else {
                    welcomeHTML += '<h3>Welcome to Your Diagnostic</h3>';
                }
                
                welcomeHTML += `
                    <p>Your confidential executive diagnostic has been prepared. Please answer all questions honestly to receive your personalized leadership analysis.</p>
                    <div class="user-info">
                `;
                
                if (userData.role) {
                    welcomeHTML += `<p><strong>Role:</strong> ${userData.role}</p>`;
                }
                
                if (userData.email) {
                    welcomeHTML += `<p><strong>Results will be sent to:</strong> ${userData.email}</p>`;
                }
                
                welcomeHTML += `
                    </div>
                    <div class="confidential-note">
                        <em>All responses are confidential and will only be used for your personalized diagnostic report.</em>
                    </div>
                </div>
                `;
                
                welcomeMessage.innerHTML = welcomeHTML;
            } else {
                // Fallback message if no user data found
                welcomeMessage.innerHTML = `
                    <div class="welcome-message">
                        <h3>Welcome to the Sovereign Protocol Diagnostic</h3>
                        <p>Please answer all questions honestly to receive your personalized leadership analysis.</p>
                        <div class="confidential-note">
                            <em>All responses are confidential and will only be used for your personalized diagnostic report.</em>
                        </div>
                    </div>
                `;
            }
            
            // Update user info display
            updateUserDisplay();
            
            // ====================
            // DIAGNOSTIC LOGIC
            // ====================
            const riskBoxes = document.querySelectorAll('.risk-box');
            const performanceScoreEl = document.getElementById('performanceScore');
            const urgencyLabel = document.getElementById('urgencyLabel');
            const urgencyDescription = document.getElementById('urgencyDescription');
            const progressBar = document.getElementById('progressBar');
            const ctaButton = document.getElementById('ctaButton');
            const completionStatus = document.getElementById('completionStatus');
            
            let userScores = {
                1: null,
                2: null,
                3: null,
                4: null,
                5: null,
                6: null,
                7: null
            };
            
            let totalAnswered = 0;
            
            // Check for existing progress
            const savedProgress = localStorage.getItem('sovereignDiagnosticProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    userScores = progress.scores;
                    totalAnswered = progress.totalAnswered;
                    
                    // Restore selected boxes
                    for (const [question, score] of Object.entries(userScores)) {
                        if (score !== null) {
                            const questionCard = document.querySelector(`[data-question="${question}"]`);
                            if (questionCard) {
                                const box = questionCard.querySelector(`[data-score="${score}"]`);
                                if (box) {
                                    box.classList.add('selected');
                                }
                            }
                        }
                    }
                    
                } catch (e) {
                    console.log('Could not restore progress:', e);
                }
            }
            
            // Add click events to all risk boxes
            riskBoxes.forEach(box => {
                box.addEventListener('click', function() {
                    const questionCard = this.closest('.question-card');
                    const questionNumber = parseInt(questionCard.dataset.question);
                    const score = parseInt(this.dataset.score);
                    
                    // Remove selected class from all boxes in this question
                    const allBoxesInQuestion = questionCard.querySelectorAll('.risk-box');
                    allBoxesInQuestion.forEach(b => b.classList.remove('selected'));
                    
                    // Add selected class to clicked box
                    this.classList.add('selected');
                    
                    // Store the score
                    if (userScores[questionNumber] === null) {
                        totalAnswered++;
                    }
                    userScores[questionNumber] = score;
                    
                    // Save progress to localStorage
                    localStorage.setItem('sovereignDiagnosticProgress', JSON.stringify({
                        scores: userScores,
                        totalAnswered: totalAnswered,
                        lastUpdated: new Date().toISOString()
                    }));
                    
                    // Update UI
                    updateResults();
                });
            });
            
            function calculatePercentageScore(rawTotal) {
                // Raw score range: 7 (best) to 21 (worst)
                // Convert to percentage where 7 = 70%, 21 = 0%
                const minRaw = 7;
                const maxRaw = 21;
                const percentage = Math.round(((maxRaw - rawTotal) / (maxRaw - minRaw)) * 70);
                // Ensure within 0-70
                return Math.min(Math.max(percentage, 0), 70);
            }
            
            function updateResults() {
                // Calculate total raw score
                let rawTotal = 0;
                let answeredCount = 0;
                
                for (const [question, score] of Object.entries(userScores)) {
                    if (score !== null) {
                        rawTotal += score;
                        answeredCount++;
                    }
                }
                
                // Calculate percentage score (0-70)
                const percentageScore = calculatePercentageScore(rawTotal);
                
                // Update score display
                performanceScoreEl.textContent = `${percentageScore}%`;
                
                // Update progress bar (width = percentage of max 70)
                const progressWidth = (percentageScore / 70) * 100;
                progressBar.style.width = `${progressWidth}%`;
                
                // Update completion status
                completionStatus.textContent = `${answeredCount}/7 questions answered`;
                
                // Update urgency level and description based on percentage
                if (answeredCount === 7) {
                    ctaButton.disabled = false;
                    
                    if (percentageScore <= 30) {
                        performanceScoreEl.className = 'urgency-score high-urgency';
                        urgencyLabel.textContent = 'Critical Urgency';
                        urgencyDescription.innerHTML = `
                            <strong>Immediate intervention required.</strong> Your leadership performance is significantly compromised. 
                            You are losing substantial strategic capacity daily. The Sovereign Protocol's Fragmented Brief Drill 
                            is designed specifically for your current state.
                        `;
                    } else if (percentageScore <= 50) {
                        performanceScoreEl.className = 'urgency-score medium-urgency';
                        urgencyLabel.textContent = 'High Urgency';
                        urgencyDescription.innerHTML = `
                            <strong>Key performance gaps detected.</strong> You are operating below your potential. 
                            The Sovereign Protocol's Transition Brief Drill will help you systematize your leadership 
                            approach and recover lost strategic time.
                        `;
                    } else {
                        performanceScoreEl.className = 'urgency-score low-urgency';
                        urgencyLabel.textContent = 'Moderate Urgency';
                        urgencyDescription.innerHTML = `
                            <strong>Performance optimization opportunity.</strong> You have a solid foundation but can benefit 
                            from elite-level protocols. The Sovereign Protocol's Integrated Brief Drill will elevate 
                            your leadership to peak performance.
                        `;
                    }
                } else {
                    ctaButton.disabled = true;
                    
                    if (answeredCount > 0) {
                        urgencyLabel.textContent = `${answeredCount}/7 Complete`;
                        urgencyDescription.textContent = `Answer all ${7 - answeredCount} remaining questions to see your performance score and personalized recommendations.`;
                    } else {
                        urgencyLabel.textContent = 'Complete Diagnostic';
                        urgencyDescription.textContent = 'Answer all questions to see your performance score and personalized recommendations.';
                    }
                    performanceScoreEl.className = 'urgency-score';
                }
            }
            
            // CTA Button click handler - Generate PDF, send email, then redirect
            ctaButton.addEventListener('click', function() {
                if (totalAnswered === 7) {
                    // Calculate final results
                    let rawTotal = 0;
                    for (const score of Object.values(userScores)) {
                        rawTotal += score;
                    }
                    
                    const percentageScore = calculatePercentageScore(rawTotal);
                    
                    // Determine urgency level based on percentage
                    let urgencyLevel;
                    if (percentageScore <= 30) urgencyLevel = 'CRITICAL';
                    else if (percentageScore <= 50) urgencyLevel = 'HIGH';
                    else urgencyLevel = 'MODERATE';
                    
                    // Store diagnostic results
                    const diagnosticResults = {
                        user: userData,
                        scores: userScores,
                        totalScore: rawTotal,
                        percentageScore: percentageScore,
                        urgencyLevel: urgencyLevel,
                        completedAt: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('sovereignDiagnosticResults', JSON.stringify(diagnosticResults));
                    
                    // Clear progress since we have final results
                    localStorage.removeItem('sovereignDiagnosticProgress');
                    
                    // Generate PDF and send email, then redirect
                    generatePDFAndSendEmail(diagnosticResults);
                }
            });
            
            // Clear Data Button Handler
            clearDataButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear your data and start over? This will remove all your answers and personal information.')) {
                    localStorage.removeItem('sovereignUserData');
                    localStorage.removeItem('sovereignDiagnosticResults');
                    localStorage.removeItem('sovereignDiagnosticProgress');
                    alert('Your data has been cleared. Please refresh the page to start over.');
                    
                    // Reset UI
                    userData = {};
                    userScores = {1: null, 2: null, 3: null, 4: null, 5: null, 6: null, 7: null};
                    totalAnswered = 0;
                    
                    // Clear selections
                    document.querySelectorAll('.risk-box.selected').forEach(box => {
                        box.classList.remove('selected');
                    });
                    
                    // Reset UI
                    updateResults();
                    updateUserDisplay();
                    location.reload();
                }
            });
            
            // Initialize
            updateResults();
        });
    </script>
</body>
</html>
