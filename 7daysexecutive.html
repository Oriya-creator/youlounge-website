<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sovereign Protocol — 7-Day Executive Alignment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ================= SUPABASE JS (single, correct init) ================= -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- REPLACE THESE WITH YOUR SUPABASE KEYS ---
    const SUPABASE_URL = "PASTE_YOUR_PROJECT_URL";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_PUBLIC_KEY";

    // IMPORTANT: use a different variable name so we don't overwrite the global "supabase"
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #0a0a0a;
      color: #f2f2f2;
      margin: 0;
      padding: 40px;
    }
    .container { max-width: 900px; margin: auto; }
    h1, h2, h3 { letter-spacing: 0.6px; }
    .confidential { color: #c7a046; font-weight: bold; letter-spacing: 1px; }
    .section { margin-bottom: 60px; }
    .protocol-day { border: 1px solid #2a2a2a; padding: 26px; margin-bottom: 26px; border-radius: 8px; background: #141414; }
    .protocol-day.locked { opacity: 0.35; pointer-events: none; }
    .protocol-day.active { border-color: #c7a046; }
    textarea { width: 100%; min-height: 85px; margin-top: 14px; background: #0e0e0e; color: #f2f2f2; border: 1px solid #333; padding: 10px; }
    button { background: #c7a046; color: #000; padding: 12px 22px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 18px; }
    button:hover { background: #e0b85a; }
    .timer { font-size: 12px; color: #aaa; margin-top: 8px; }
    .footer { text-align: center; font-size: 12px; color: #777; margin-top: 80px; }
    hr { border: none; border-top: 1px solid #2a2a2a; margin: 28px 0; }
  </style>
</head>

<body>
  <script>
    // =================== COURSE ACCESS PROTECTION ===================
    // This expects a table "purchases" with:
    // user_id (uuid), course_id (text or uuid), paid (boolean)
    // If you're using a different table (e.g., user_access), tell me and I’ll swap it cleanly.

    const COURSE_ID = "7day"; // <-- change to your real course id/slug/uuid used in your purchases table

    async function checkCourseAccess(courseId) {
      const { data: { session }, error: sessionErr } = await supabaseClient.auth.getSession();

      if (sessionErr) {
        console.error("Session error:", sessionErr);
      }

      if (!session || !session.user) {
        // Not logged in → redirect to login page
        window.location.href = "/login.html";
        return;
      }

      const { data, error } = await supabaseClient
        .from("purchases")
        .select("id, paid")
        .eq("user_id", session.user.id)
        .eq("course_id", courseId)
        .eq("paid", true)
        .limit(1);

      if (error) {
        console.error("Purchase check error:", error);
        // Fail closed: treat as no access
        window.location.href = "/payment-page.html";
        return;
      }

      if (!data || data.length === 0) {
        // Has not purchased → redirect to payment page
        window.location.href = "/payment-page.html";
        return;
      }

      // Access OK → stay on page
    }

    // Run immediately
    checkCourseAccess(COURSE_ID);
  </script>

  <div class="container">
    <h1>SOVEREIGN PROTOCOL</h1>
    <h2>7-Day Executive Alignment Installation</h2>
    <p class="confidential">CONFIDENTIAL — EXECUTIVE USE ONLY</p>
    <p>
      This installation governs <strong>internal alignment before external authority</strong>.<br>
      Completion requires discipline. Order is enforced by design.
    </p>
    <hr>

    <div class="section">
      <h3>Installation Instructions</h3>
      <ul>
        <li>One day unlocks every 24 hours</li>
        <li>Written integration is mandatory</li>
        <li>Skipping ahead is structurally impossible</li>
        <li>This protocol prepares you for governance-level installation</li>
      </ul>
    </div>
    <hr>

    <div id="protocol-installation">
      <div class="protocol-day active" data-day="1">
        <h3>Day 1 — Identity Alignment</h3>
        <p>Clarify who you are operating as — not aspirationally, but functionally.</p>
        <textarea placeholder="State the identity you will now operate from."></textarea>
        <button onclick="completeDay(1)">Confirm & Install</button>
        <div class="timer" id="timer-1"></div>
      </div>

      <div class="protocol-day locked" data-day="2">
        <h3>Day 2 — Authority Alignment</h3>
        <p>Define where authority is held, expressed, and restrained.</p>
        <textarea placeholder="Describe how authority will now be exercised."></textarea>
        <button onclick="completeDay(2)">Confirm & Install</button>
        <div class="timer" id="timer-2"></div>
      </div>

      <div class="protocol-day locked" data-day="3">
        <h3>Day 3 — Decision Coherence</h3>
        <p>Eliminate contradiction across decisions.</p>
        <textarea placeholder="State the rule governing your decisions."></textarea>
        <button onclick="completeDay(3)">Confirm & Install</button>
        <div class="timer" id="timer-3"></div>
      </div>

      <div class="protocol-day locked" data-day="4">
        <h3>Day 4 — Emotional Sovereignty</h3>
        <p>Ensure emotions inform but never govern.</p>
        <textarea placeholder="Describe the emotional standard you will uphold."></textarea>
        <button onclick="completeDay(4)">Confirm & Install</button>
        <div class="timer" id="timer-4"></div>
      </div>

      <div class="protocol-day locked" data-day="5">
        <h3>Day 5 — Energy Discipline</h3>
        <p>Direct energy only where authority is required.</p>
        <textarea placeholder="Define where your energy is now prohibited."></textarea>
        <button onclick="completeDay(5)">Confirm & Install</button>
        <div class="timer" id="timer-5"></div>
      </div>

      <div class="protocol-day locked" data-day="6">
        <h3>Day 6 — Internal Order</h3>
        <p>Resolve internal fragmentation.</p>
        <textarea placeholder="State the order you are enforcing internally."></textarea>
        <button onclick="completeDay(6)">Confirm & Install</button>
        <div class="timer" id="timer-6"></div>
      </div>

      <div class="protocol-day locked" data-day="7">
        <h3>Day 7 — Sovereign Lock</h3>
        <p>Seal alignment as default operating state.</p>
        <textarea placeholder="Declare the standard you will not violate."></textarea>
        <button onclick="completeDay(7)">Lock Installation</button>
        <div class="timer" id="timer-7"></div>
      </div>
    </div>

    <div class="section">
      <h3>Transition Notice</h3>
      <p>Completion of this protocol does not expand capacity.<br>It stabilizes it.</p>
      <p>What follows is not self-work — it is <strong>governance</strong>.</p>
      <p class="confidential">→ Eligible for: 21-Day Executive Governance Systems</p>
    </div>

    <div class="footer">
      © Sovereign Protocol — Executive Alignment Architecture
    </div>
  </div>

  <script>
    const LOCK_HOURS = 24;

    function completeDay(day) {
      const text = document.querySelector(`[data-day="${day}"] textarea`).value.trim();
      if (!text) {
        alert("Integration is required before proceeding.");
        return;
      }
      localStorage.setItem("sp7_day_" + day, Date.now());
      updateAccess();
    }

    function updateAccess() {
      document.querySelectorAll(".protocol-day").forEach(el => {
        const day = parseInt(el.getAttribute("data-day"), 10);
        if (day === 1) return;

        const prevCompleted = localStorage.getItem("sp7_day_" + (day - 1));
        if (!prevCompleted) return;

        const unlockTime = parseInt(prevCompleted, 10) + LOCK_HOURS * 60 * 60 * 1000;
        const now = Date.now();

        if (now >= unlockTime) {
          el.classList.remove("locked");
          el.classList.add("active");
          const t = document.getElementById("timer-" + day);
          if (t) t.innerText = "";
        } else {
          const remaining = unlockTime - now;
          const hrs = Math.floor(remaining / (1000 * 60 * 60));
          const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          const t = document.getElementById("timer-" + day);
          if (t) t.innerText = `Next installation unlocks in ${hrs}h ${mins}m`;
        }
      });
    }

    updateAccess();
    setInterval(updateAccess, 60000);
  </script>
</body>
</html>
